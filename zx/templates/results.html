<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        width: 100%;
        max-width: 800px;
      }

      .quiz-box {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 50px 40px;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.3),
          0 0 40px rgba(255, 215, 0, 0.2), 0 0 60px rgba(255, 215, 0, 0.1),
          0 8px 32px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
      }

      .quiz-box::before {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #ffd700, #ffa500, #ffd700, #ffa500);
        border-radius: 20px;
        z-index: -1;
        animation: glow 3s ease-in-out infinite;
        opacity: 0.6;
      }

      @keyframes glow {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(255, 215, 0, 0.5),
            0 0 40px rgba(255, 215, 0, 0.3), 0 0 60px rgba(255, 215, 0, 0.2);
        }
        50% {
          box-shadow: 0 0 30px rgba(255, 215, 0, 0.7),
            0 0 60px rgba(255, 215, 0, 0.5), 0 0 90px rgba(255, 215, 0, 0.3);
        }
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      h2 {
        color: #2d2d2d;
        font-size: 32px;
        font-weight: 600;
        margin-bottom: 10px;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.3),
          0 0 20px rgba(255, 215, 0, 0.2);
      }

      .subtitle {
        color: #666;
        font-size: 14px;
      }

      .btn {
        padding: 14px 30px;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn-prev {
        background: white;
        color: #333;
        border: 2px solid #e0e0e0;
      }

      .btn-prev:hover:not(:disabled) {
        border-color: #ffd700;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.2),
          0 0 30px rgba(255, 215, 0, 0.1);
      }

      .btn-next {
        background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
        color: #1a1a1a;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.4),
          0 0 40px rgba(255, 215, 0, 0.2), 0 4px 15px rgba(255, 165, 0, 0.3);
        flex: 1;
      }

      .btn-next:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.6),
          0 0 60px rgba(255, 215, 0, 0.4), 0 6px 20px rgba(255, 165, 0, 0.4);
      }

      .navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        gap: 15px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="quiz-box">
        <div id="resultsContent">
          <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
        </div>
      </div>
    </div>

    <script>
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get("user_id");
        loadResults(userId);
      });

      async function loadResults(userId) {
        try {
          console.log("Loading results for user:", userId);
          const response = await fetch(`/get_user_results?user_id=${userId}`);

          console.log("Response status:", response.status);

          if (response.ok) {
            const data = await response.json();
            console.log("Received data:", data);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
            if (data.results) {
              showResults(data);
            } else if (data.error) {
              showError("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã: " + data.error);
            } else {
              showError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
            }
          } else {
            const errorText = await response.text();
            showError(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} - ${errorText}`);
          }
        } catch (error) {
          console.error("Error loading results:", error);
          showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: " + error.message);
        }
      }

      function showResults(data) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ data –∏ data.results —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        if (!data || !data.results) {
          console.error("Invalid data structure:", data);
          showError("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤");
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ results —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
        const results = data.results;
        if (
          typeof results.A === "undefined" ||
          typeof results.B === "undefined" ||
          typeof results.C === "undefined" ||
          typeof results.D === "undefined"
        ) {
          console.error("Invalid results structure:", results);
          showError("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤");
          return;
        }

        const hasImage =
          data.image && data.image.startsWith("data:image/png;base64");
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get("user_id");

        // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
        const dominantType = getDominantType(data.results);
        let redirectUrl = "/A";
        if (dominantType.includes("–ö–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä"))
          redirectUrl = "/B";
        if (dominantType.includes("–¢–≤–æ—Ä–µ—Ü-–∏–Ω–æ–≤–∞—Ç–æ—Ä")) redirectUrl = "/C";
        if (dominantType.includes("–ê–Ω–∞–ª–∏—Ç–∏–∫-—Å—Ç—Ä–∞—Ç–µ–≥")) redirectUrl = "/D";

        const content = document.getElementById("resultsContent");
        content.innerHTML = `
      ${
        hasImage
          ? `
          <div style="text-align: center; margin: 30px 0;">
              <img src="${data.image}" alt="–ì—Ä–∞—Ñ–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤" 
                   style="max-width: 100%; max-height: 400px; border-radius: 15px; 
                          box-shadow: 0 8px 25px rgba(0,0,0,0.15); border: 3px solid #ffd700;">
          </div>
      `
          : `
          <div style="text-align: center; margin: 20px 0; color: #ff6b6b;">
              <p>‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫, –Ω–æ –≤–æ—Ç –≤–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:</p>
          </div>
      `
      }
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 25px 0;">
          <div class="result-type" style="background: linear-gradient(135deg, rgba(255,107,107,0.15), rgba(255,107,107,0.25)); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #FF6B6B;">
              <div style="font-weight: bold; color: #FF6B6B; font-size: 16px; margin-bottom: 8px;">–ü—Ä–∞–∫—Ç–∏–∫-–¥–µ—è—Ç–µ–ª—å</div>
              <div style="font-size: 28px; font-weight: bold; color: #FF6B6B;">${
                results.A || 0
              }</div>
              <div style="font-size: 12px; color: #666; margin-top: 5px;">–¢–µ–±–µ –≤–∞–∂–Ω–æ –≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–≤–æ–∏—Ö —É—Å–∏–ª–∏–π, —Ç—ã —ç–Ω–µ—Ä–≥–∏—á–µ–Ω –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ –¥–µ–π—Å—Ç–≤–∏–µ. –ù–µ –±–æ–∏—à—å—Å—è —Ñ–∏–∑. —Ç—Ä—É–¥–∞ –∏ –ª—é–±–∏—à—å, –∫–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞ –∫–∏–ø–∏—Ç.</div>
          </div>
          <div class="result-type" style="background: linear-gradient(135deg, rgba(78,205,196,0.15), rgba(78,205,196,0.25)); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #4ECDC4;">
              <div style="font-weight: bold; color: #4ECDC4; font-size: 16px; margin-bottom: 8px;">–ö–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</div>
              <div style="font-size: 28px; font-weight: bold; color: #4ECDC4;">${
                results.B || 0
              }</div>
              <div style="font-size: 12px; color: #666; margin-top: 5px;">–¢—ã - –º–∞—Å—Ç–µ—Ä –æ–±—â–µ–Ω–∏—è. –¢–µ–±–µ –ª–µ–≥–∫–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –æ–±—â–∏–π —è–∑—ã–∫ —Å –ª—é–¥—å–º–∏, —Ç—ã —É–º–µ–µ—à—å –≤–¥–æ—Ö–Ω–æ–≤–ª—è—Ç—å, —É–±–µ–∂–¥–∞—Ç—å –∏ –ø–æ–º–æ–≥–∞—Ç—å. –†–∞–±–æ—Ç–∞ –≤ –∫–æ–º–∞–Ω–¥–µ - —Ç–≤–æ—è —Å—Ç–∏—Ö–∏—è.</div>
          </div>
          <div class="result-type" style="background: linear-gradient(135deg, rgba(69,183,209,0.15), rgba(69,183,209,0.25)); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #45B7D1;">
              <div style="font-weight: bold; color: #45B7D1; font-size: 16px; margin-bottom: 8px;">–¢–≤–æ—Ä–µ—Ü-–∏–Ω–æ–≤–∞—Ç–æ—Ä</div>
              <div style="font-size: 28px; font-weight: bold; color: #45B7D1;">${
                results.C || 0
              }</div>
              <div style="font-size: 12px; color: #666; margin-top: 5px;">–¢—ã –æ–±–ª–∞–¥–∞–µ—à—å —è—Ä–∫–∏–º –≤–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∏ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –º—ã—à–ª–µ–Ω–∏–µ–º. –¢–µ–±–µ –≤–∞–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ, –≤—ã—Ä–∞–∂–∞—Ç—å —Å–≤–æ–∏ –∏–¥–µ–∏ –∏ –º–µ–Ω—è—Ç—å –º–∏—Ä –≤–æ–∫—Ä—É–≥ —á–µ—Ä–µ–∑ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ –∏ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏</div>
          </div>
          <div class="result-type" style="background: linear-gradient(135deg, rgba(150,206,180,0.15), rgba(150,206,180,0.25)); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #96CEB4;">
              <div style="font-weight: bold; color: #96CEB4; font-size: 16px; margin-bottom: 8px;">–ê–Ω–∞–ª–∏—Ç–∏–∫-—Å—Ç—Ä–∞—Ç–µ–≥</div>
              <div style="font-size: 28px; font-weight: bold; color: #96CEB4;">${
                results.D || 0
              }</div>
              <div style="font-size: 12px; color: #666; margin-top: 5px;">–¢—ã - –ª–æ–≥–∏–∫ –∏ —Å—Ç—Ä–∞—Ç–µ–≥. –¢–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π, —Ü–∏—Ñ—Ä–∞–º–∏ –∏ —Å—Ö–µ–º–∞–º–∏. –¢—ã —Ü–µ–Ω–∏—à—å –ø–æ—Ä—è–¥–æ–∫, —Ç–æ—á–Ω–æ—Å—Ç—å –∏ –ª—é–±–∏—à—å –¥–æ–∫–∞–ø—ã–≤–∞—Ç—å—Å—è –¥–æ —Å—É—Ç–∏ –≤–µ—â–∏.</div>
          </div>
      </div>
      
      <div style="background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,165,0,0.1)); padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 4px solid #ffd700;">
        <div style="font-weight: bold; color: #2d2d2d; margin-bottom: 10px;">
          ${
            dominantTypes.length === 4
              ? "üéØ –í–∞—à —Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏:"
              : "üìà –í–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∏–ø:"
          }
        </div>
        <div style="font-size: 18px; font-weight: bold; color: #ffa500;">
          ${getDominantType(data.results)}
        </div>
        ${
          dominantTypes.length > 1 
          ? ` <div style="font-size: 14px; color: #666; margin-top: 10px;">
            üí° –£ –≤–∞—Å –≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ —Ä–∞–∑–≤–∏—Ç—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—á–µ—Å—Ç–≤!
              </div>
            `
          : ""
        }
</div>
      
      <div class="navigation">
          <button class="btn btn-prev" onclick="window.location.href='/questions?user_id=${userId}'" style="flex: 1;">
              üîÑ –ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ
          </button>
          <button class="btn btn-next" onclick="window.location.href='${redirectUrl}?user_id=${userId}'" style="flex: 1;">
              üéØ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
          </button>
      </div>
    `;
      }

      function showError(message) {
        const content = document.getElementById("resultsContent");
        const urlParams = new URLSearchParams(window.location.search);

        content.innerHTML = `
          <div style="text-align: center; color: #ff6b6b;">
            <p>${message}</p>
            <button class="btn btn-next" onclick="window.location.href='/questions?user_id=${urlParams.get(
              "user_id"
            )}'" style="margin-top: 20px;">
              –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–µ—Å—Ç—É
            </button>
          </div>
        `;
      }

      function getDominantType(results) {
        if (!results) return "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω";

        // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —Ç–∏–ø–æ–≤ —Å –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        const types = [
          { type: "A", name: "–ü—Ä–∞–∫—Ç–∏–∫-–¥–µ—è—Ç–µ–ª—å", count: results.A || 0 },
          {
            type: "B",
            name: "–ö–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä",
            count: results.B || 0,
          },
          { type: "C", name: "–¢–≤–æ—Ä–µ—Ü-–∏–Ω–æ–≤–∞—Ç–æ—Ä", count: results.C || 0 },
          { type: "D", name: "–ê–Ω–∞–ª–∏—Ç–∏–∫-—Å—Ç—Ä–∞—Ç–µ–≥", count: results.D || 0 },
        ];

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é
        types.sort((a, b) => b.count - a.count);

        const maxCount = types[0].count;

        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Ç–∏–ø—ã —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
        const dominantTypes = types.filter((t) => t.count === maxCount);

        // –ï—Å–ª–∏ –≤—Å–µ –Ω—É–ª–∏
        if (maxCount === 0) {
          return "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω";
        }

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ª—É—á–∞–∏
        switch (dominantTypes.length) {
          case 1:
            return dominantTypes[0].name;
          case 2:
            return `${dominantTypes[0].name} –∏ ${dominantTypes[1].name}`;
          case 3:
            return `${dominantTypes[0].name}, ${dominantTypes[1].name} –∏ ${dominantTypes[2].name}`;
          case 4:
            return "–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–∏–ø (–≤—Å–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–∞–∑–≤–∏—Ç—ã –æ–¥–∏–Ω–∞–∫–æ–≤–æ)";
          default:
            return "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω";
        }
      }
    </script>
  </body>
</html>
