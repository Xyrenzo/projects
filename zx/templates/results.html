<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Результаты теста</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        width: 100%;
        max-width: 800px;
      }

      .quiz-box {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 50px 40px;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.3),
          0 0 40px rgba(255, 215, 0, 0.2), 0 0 60px rgba(255, 215, 0, 0.1),
          0 8px 32px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
      }

      .quiz-box::before {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #ffd700, #ffa500, #ffd700, #ffa500);
        border-radius: 20px;
        z-index: -1;
        animation: glow 3s ease-in-out infinite;
        opacity: 0.6;
      }

      @keyframes glow {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(255, 215, 0, 0.5),
            0 0 40px rgba(255, 215, 0, 0.3), 0 0 60px rgba(255, 215, 0, 0.2);
        }
        50% {
          box-shadow: 0 0 30px rgba(255, 215, 0, 0.7),
            0 0 60px rgba(255, 215, 0, 0.5), 0 0 90px rgba(255, 215, 0, 0.3);
        }
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      h2 {
        color: #2d2d2d;
        font-size: 32px;
        font-weight: 600;
        margin-bottom: 10px;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.3),
          0 0 20px rgba(255, 215, 0, 0.2);
      }

      .subtitle {
        color: #666;
        font-size: 14px;
      }

      .btn {
        padding: 14px 30px;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn-prev {
        background: white;
        color: #333;
        border: 2px solid #e0e0e0;
      }

      .btn-prev:hover:not(:disabled) {
        border-color: #ffd700;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.2),
          0 0 30px rgba(255, 215, 0, 0.1);
      }

      .btn-next {
        background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
        color: #1a1a1a;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.4),
          0 0 40px rgba(255, 215, 0, 0.2), 0 4px 15px rgba(255, 165, 0, 0.3);
        flex: 1;
      }

      .btn-next:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.6),
          0 0 60px rgba(255, 215, 0, 0.4), 0 6px 20px rgba(255, 165, 0, 0.4);
      }

      .navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        gap: 15px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="quiz-box">
        <div id="resultsContent">
          <!-- Результаты загрузятся через JavaScript -->
        </div>
      </div>
    </div>

    <script>
      // Загружаем результаты при загрузке страницы
      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get("user_id");
        loadResults(userId);
      });

      async function loadResults(userId) {
        try {
          console.log("Loading results for user:", userId);
          const response = await fetch(`/get_user_results?user_id=${userId}`);

          console.log("Response status:", response.status);

          if (response.ok) {
            const data = await response.json();
            console.log("Received data:", data);

            // Проверяем структуру данных
            if (data.results) {
              showResults(data);
            } else if (data.error) {
              showError("Результаты не найдены: " + data.error);
            } else {
              showError("Неверный формат данных от сервера");
            }
          } else {
            const errorText = await response.text();
            showError(`Ошибка сервера: ${response.status} - ${errorText}`);
          }
        } catch (error) {
          console.error("Error loading results:", error);
          showError("Ошибка загрузки результатов: " + error.message);
        }
      }

      function showResults(data) {
        // Проверяем что data и data.results существуют
        if (!data || !data.results) {
          console.error("Invalid data structure:", data);
          showError("Неверные данные результатов");
          return;
        }

        // Проверяем что results содержит нужные поля
        const results = data.results;
        if (
          typeof results.A === "undefined" ||
          typeof results.B === "undefined" ||
          typeof results.C === "undefined" ||
          typeof results.D === "undefined"
        ) {
          console.error("Invalid results structure:", results);
          showError("Неверная структура результатов");
          return;
        }

        const hasImage =
          data.image && data.image.startsWith("data:image/png;base64");
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get("user_id");

        // Остальной код без изменений...
        const dominantType = getDominantType(data.results);
        let redirectUrl = "/A";
        if (dominantType.includes("Коммуникатор-организатор"))
          redirectUrl = "/B";
        if (dominantType.includes("Творец-иноватор")) redirectUrl = "/C";
        if (dominantType.includes("Аналитик-стратег")) redirectUrl = "/D";

        const content = document.getElementById("resultsContent");
        content.innerHTML = `
      ${
        hasImage
          ? `
          <div style="text-align: center; margin: 30px 0;">
              <img src="${data.image}" alt="График результатов" 
                   style="max-width: 100%; max-height: 400px; border-radius: 15px; 
                          box-shadow: 0 8px 25px rgba(0,0,0,0.15); border: 3px solid #ffd700;">
          </div>
      `
          : `
          <div style="text-align: center; margin: 20px 0; color: #ff6b6b;">
              <p>⚠️ Не удалось создать график, но вот ваши результаты:</p>
          </div>
      `
      }
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 25px 0;">
          <div class="result-type" style="background: linear-gradient(135deg, rgba(255,107,107,0.15), rgba(255,107,107,0.25)); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #FF6B6B;">
              <div style="font-weight: bold; color: #FF6B6B; font-size: 16px; margin-bottom: 8px;">Практик-деятель</div>
              <div style="font-size: 28px; font-weight: bold; color: #FF6B6B;">${
                results.A || 0
              }</div>
              <div style="font-size: 12px; color: #666; margin-top: 5px;">Тебе важно видеть результаты своих усилий, ты энергичен и ориентирован на действие. Не боишься физ. труда и любишь, когда работа кипит.</div>
          </div>
          <div class="result-type" style="background: linear-gradient(135deg, rgba(78,205,196,0.15), rgba(78,205,196,0.25)); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #4ECDC4;">
              <div style="font-weight: bold; color: #4ECDC4; font-size: 16px; margin-bottom: 8px;">Коммуникатор-организатор</div>
              <div style="font-size: 28px; font-weight: bold; color: #4ECDC4;">${
                results.B || 0
              }</div>
              <div style="font-size: 12px; color: #666; margin-top: 5px;">Ты - мастер общения. Тебе легко находить общий язык с людьми, ты умеешь вдохновлять, убеждать и помогать. Работа в команде - твоя стихия.</div>
          </div>
          <div class="result-type" style="background: linear-gradient(135deg, rgba(69,183,209,0.15), rgba(69,183,209,0.25)); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #45B7D1;">
              <div style="font-weight: bold; color: #45B7D1; font-size: 16px; margin-bottom: 8px;">Творец-иноватор</div>
              <div style="font-size: 28px; font-weight: bold; color: #45B7D1;">${
                results.C || 0
              }</div>
              <div style="font-size: 12px; color: #666; margin-top: 5px;">Ты обладаешь ярким воображением и нестандартным мышлением. Тебе важно создавать что-то новое, выражать свои идеи и менять мир вокруг через творчество и инновации</div>
          </div>
          <div class="result-type" style="background: linear-gradient(135deg, rgba(150,206,180,0.15), rgba(150,206,180,0.25)); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #96CEB4;">
              <div style="font-weight: bold; color: #96CEB4; font-size: 16px; margin-bottom: 8px;">Аналитик-стратег</div>
              <div style="font-size: 28px; font-weight: bold; color: #96CEB4;">${
                results.D || 0
              }</div>
              <div style="font-size: 12px; color: #666; margin-top: 5px;">Ты - логик и стратег. Тебе нравится работать с информацией, цифрами и схемами. Ты ценишь порядок, точность и любишь докапываться до сути вещи.</div>
          </div>
      </div>
      
      <div style="background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,165,0,0.1)); padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 4px solid #ffd700;">
        <div style="font-weight: bold; color: #2d2d2d; margin-bottom: 10px;">
          ${
            dominantTypes.length === 4
              ? "🎯 Ваш тип личности:"
              : "📈 Ваш основной тип:"
          }
        </div>
        <div style="font-size: 18px; font-weight: bold; color: #ffa500;">
          ${getDominantType(data.results)}
        </div>
        ${
          dominantTypes.length > 1 
          ? ` <div style="font-size: 14px; color: #666; margin-top: 10px;">
            💡 У вас гармонично развиты несколько качеств!
              </div>
            `
          : ""
        }
</div>
      
      <div class="navigation">
          <button class="btn btn-prev" onclick="window.location.href='/questions?user_id=${userId}'" style="flex: 1;">
              🔄 Пройти заново
          </button>
          <button class="btn btn-next" onclick="window.location.href='${redirectUrl}?user_id=${userId}'" style="flex: 1;">
              🎯 Посмотреть профессии
          </button>
      </div>
    `;
      }

      function showError(message) {
        const content = document.getElementById("resultsContent");
        const urlParams = new URLSearchParams(window.location.search);

        content.innerHTML = `
          <div style="text-align: center; color: #ff6b6b;">
            <p>${message}</p>
            <button class="btn btn-next" onclick="window.location.href='/questions?user_id=${urlParams.get(
              "user_id"
            )}'" style="margin-top: 20px;">
              Вернуться к тесту
            </button>
          </div>
        `;
      }

      function getDominantType(results) {
        if (!results) return "Не определен";

        // Создаем массив типов с их значениями
        const types = [
          { type: "A", name: "Практик-деятель", count: results.A || 0 },
          {
            type: "B",
            name: "Коммуникатор-организатор",
            count: results.B || 0,
          },
          { type: "C", name: "Творец-иноватор", count: results.C || 0 },
          { type: "D", name: "Аналитик-стратег", count: results.D || 0 },
        ];

        // Сортируем по убыванию
        types.sort((a, b) => b.count - a.count);

        const maxCount = types[0].count;

        // Находим все типы с максимальным количеством
        const dominantTypes = types.filter((t) => t.count === maxCount);

        // Если все нули
        if (maxCount === 0) {
          return "Не определен";
        }

        // Обрабатываем разные случаи
        switch (dominantTypes.length) {
          case 1:
            return dominantTypes[0].name;
          case 2:
            return `${dominantTypes[0].name} и ${dominantTypes[1].name}`;
          case 3:
            return `${dominantTypes[0].name}, ${dominantTypes[1].name} и ${dominantTypes[2].name}`;
          case 4:
            return "Сбалансированный тип (все качества развиты одинаково)";
          default:
            return "Не определен";
        }
      }
    </script>
  </body>
</html>
